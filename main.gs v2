/**
 * 指定されたGoogle Driveフォルダ内のファイル一覧を取得し、
 * ファイル名、URL、最終更新日時、オーナー情報を指定されたスプレ-ッドシートに一括で書き出す。
 * 【エラー修正版】共有ドライブ内のファイルなど、オーナーが取得できない場合に対応。
 *
 * 【事前準備】
 * 1. スクリプトエディタのメニューから「プロジェクトの設定」>「スクリプト プロパティ」を選択します。
 * 2. 「スクリプト プロパティを追加」をクリックし、以下の2つを設定します。
 * - プロパティ名: FOLDER_ID, 値: ファイル一覧を取得したいGoogle DriveのフォルダID
 * - プロパティ名: SPREADSHEET_ID, 値: 書き込み先のGoogleスプレッドシートのID
 */
function createDetailedFileListInSpreadsheet_Fixed() {
  try {
    // 1. スクリプトプロパティからIDを取得
    const properties = PropertiesService.getScriptProperties();
    const folderId = properties.getProperty('FOLDER_ID');
    const sheetId = properties.getProperty('SPREADSHEET_ID');

    if (!folderId || !sheetId) {
      const errorMessage = 'フォルダIDまたはスプレッドシートIDがスクリプトプロパティに設定されていません。';
      Logger.log(errorMessage);
      return;
    }

    const folder = DriveApp.getFolderById(folderId);
    const sheet = SpreadsheetApp.openById(sheetId).getActiveSheet();

    // 2. ファイル情報を配列にまとめて取得
    const files = folder.getFiles();
    const fileInfoList = [];
    while (files.hasNext()) {
      const file = files.next();
      
      const lastUpdated = file.getLastUpdated();
      
      // 【変更点】オーナーが null でないかを確認してからメールアドレスを取得
      const ownerObject = file.getOwner();
      const ownerEmail = ownerObject ? ownerObject.getEmail() : '（オーナー情報なし）'; // オーナーが存在しない場合は代替テキストを設定

      fileInfoList.push([
        file.getName(),
        file.getUrl(),
        lastUpdated,
        ownerEmail // 確認済みのオーナー情報を追加
      ]);
    }

    // 3. シートをクリアし、データを一括書き込み
    sheet.clear();
    sheet.getRange(1, 1, 1, 4).setValues([['ファイル名', 'URL', '最終更新日時', 'オーナー']]);

    if (fileInfoList.length > 0) {
      sheet.getRange(2, 1, fileInfoList.length, 4).setValues(fileInfoList);
    }

    Logger.log('ファイルリストの書き込みが完了しました。');

  } catch (e) {
    // 4. エラーハンドリング
    const errorMessage = `エラーが発生しました: ${e.message}\n` +
                       `- 指定したフォルダIDまたはスプレッドシートIDが正しいか確認してください。\n` +
                       `- スクリプトに適切な権限が付与されているか確認してください。`;
    Logger.log(errorMessage);
  }
}
